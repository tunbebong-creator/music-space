<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chi tiáº¿t sá»± kiá»‡n â€¢ Music Space</title>

  <!-- Base site styles -->
  <link rel="stylesheet" href="/assets/style.css" />
  <!-- Trang event -->
  <link rel="stylesheet" href="/assets/event.css" />
  <!-- Modal Ä‘áº·t vÃ© -->
  <link rel="stylesheet" href="/assets/booking.css" />

  <!-- Leaflet (chá»‰ dÃ¹ng náº¿u cÃ³ Lat/Lng Ä‘á»ƒ hiá»ƒn thá»‹ mini map) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>

<body>
  <!-- NAV -->
  <nav class="navbar">
    <div class="nav-inner">
      <a class="brand" href="/index.html">
        <span class="logo">â¤</span>
        <span><strong>Music</strong> <span class="space">Space</span></span>
      </a>
      <div class="nav-links">
        <a href="#" class="chip">âœ¨ I'm Healing</a>
        <a href="/pages/healing-space.html" class="chip">ğŸ—º Healing Space</a>
        <a href="#" class="chip">ğŸ‘¥ We Share</a>
        <a href="#" class="chip">ğŸ“– We Read</a>
      </div>
      <div class="nav-actions">
        <button class="icon-btn">ğŸ”ˆ</button>
        <div class="user-box">
          <button class="icon-btn" id="btnUser">ğŸ‘¤</button>
          <div id="user-info"></div>
        </div>
      </div>
    </div>
  </nav>

  <main class="page">
    <a class="back" href="javascript:history.back()">â† Quay láº¡i</a>

    <section class="event-card" id="event-card" hidden>
      <div class="hero">
        <img id="ev-cover" class="cover" alt="">
        <div>
          <div class="tags" id="ev-tags"></div>
          <div class="title" id="ev-title">â€”</div>

          <div class="facts">
            <div class="fact"><span class="icon">ğŸ“…</span><span id="ev-date">â€”</span></div>
            <div class="fact"><span class="icon">â±</span><span id="ev-time">â€”</span></div>
            <div class="fact"><span class="icon">ğŸ“</span><span id="ev-venue">â€”</span></div>
            <div class="fact"><span class="icon">ğŸ‘¥</span><span id="ev-capacity" class="muted">â€”</span></div>
            <div class="fact"><span class="icon">ğŸ·ï¸</span><span id="ev-price" class="price">â€”</span></div>
          </div>

          <button id="btnBook" class="cta-btn">Äáº·t vÃ© ngay</button>
        </div>
      </div>

      <div class="section">
        <h3>MÃ´ táº£ sá»± kiá»‡n</h3>
        <div id="ev-desc" class="muted">â€”</div>
      </div>

      <div class="section">
        <h3>Lá»£i Ã­ch tham gia</h3>
        <div id="ev-benefits" class="ul"></div>
      </div>

      <div class="section">
        <h3>YÃªu cáº§u tham gia</h3>
        <div id="ev-reqs" class="ul"></div>
      </div>

      <div class="section">
        <h3>Báº£n Ä‘á»“</h3>
        <div id="map"></div>
      </div>
    </section>

    <section class="section" id="empty">
      <p class="muted">Äang táº£i sá»± kiá»‡n...</p>
    </section>
  </main>

  <!-- FOOTER -->
  <footer class="footer">
    <div class="footer-inner">
      <div class="footer-col">
        <div class="brand-footer">
          <span class="logo">â¤</span>
          <div>
            <div class="brand-text"><strong>Music</strong> <span class="space">Space</span></div>
            <p class="tagline">Vietnam's Healing Music Map</p>
          </div>
        </div>
      </div>
    </div>
    <div class="copyright">Â© 2025 Music Space. All rights reserved.</div>
  </footer>

  <!-- Booking Modal -->
  <div id="book-modal" class="ms-modal hidden" aria-hidden="true">
    <div class="ms-modal__backdrop" data-close></div>
    <div class="ms-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="book-title">
      <div class="ms-modal__header">
        <h3 id="book-title">Chá»n phÆ°Æ¡ng thá»©c thanh toÃ¡n</h3>
        <button class="ms-modal__close" title="ÄÃ³ng" data-close>Ã—</button>
      </div>

      <div class="ms-modal__body">
        <div class="pay-options">
          <button id="btnCash" class="pay-option">
            <span class="emoji">ğŸ’µ</span>
            <div>
              <div class="t">Thanh toÃ¡n tiá»n máº·t</div>
              <div class="d">Äiá»n thÃ´ng tin, thanh toÃ¡n táº¡i sá»± kiá»‡n</div>
            </div>
          </button>

          <button id="btnOnline" class="pay-option disabled" disabled>
            <span class="emoji">ğŸ¦</span>
            <div>
              <div class="t">Online Banking</div>
              <div class="d">Coming soonâ€¦</div>
            </div>
          </button>
        </div>

        <!-- Form tiá»n máº·t -->
        <form id="cash-form" class="cash-form hidden">
          <div class="f-row">
            <label>Há» tÃªn *</label>
            <input required name="fullName" placeholder="Nguyá»…n VÄƒn A">
          </div>
          <div class="f-row">
            <label>Email *</label>
            <input type="email" required name="email" placeholder="you@email.com">
          </div>
          <div class="f-row">
            <label>Sá»‘ Ä‘iá»‡n thoáº¡i *</label>
            <input required name="phone" placeholder="09xx xxx xxx">
          </div>
          <div class="f-row">
            <label>Sá»‘ lÆ°á»£ng vÃ©</label>
            <input type="number" name="qty" min="1" value="1">
          </div>

          <div class="actions">
            <button type="button" class="btn ghost" data-close>Há»§y</button>
            <button type="submit" class="btn primary">XÃ¡c nháº­n giá»¯ chá»—</button>
          </div>
          <div id="cash-msg" class="msg"></div>
        </form>
      </div>
    </div>
  </div>

  <!-- JS -->
  <script>
    const API = '/api';
    const qs = new URLSearchParams(location.search);
    const slug = (qs.get('slug') || '').trim();
    const $$ = (s, el = document) => el.querySelector(s);

    const fmtDate = t => t ? new Date(t).toLocaleDateString('vi-VN', { weekday: 'short', day: '2-digit', month: '2-digit', year: 'numeric' }) : '';
    const fmtTimeHM = t => t ? new Date(t).toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' }) : '';
    const money = (cents, cur = 'VND') => cents == null ? '' : (Math.round(Number(cents) / 100)).toLocaleString('vi-VN') + ' ' + cur;

    let CURRENT_EVENT = null;

    // gom key PascalCase/snake_case vá» 1 object E
    function normalize(ev) {
      return {
        slug: ev.slug ?? ev.Slug,
        title: ev.title ?? ev.Title,
        category: ev.category ?? ev.Category,
        city: ev.city ?? ev.City,
        venue_name: ev.venue_name ?? ev.VenueName,
        venue_address: ev.venue_address ?? ev.VenueAddress,
        capacity: ev.capacity ?? ev.Capacity,
        price_cents: ev.price_cents ?? ev.PriceCents,
        currency: ev.currency ?? ev.Currency,
        thumbnail_url: ev.thumbnail_url ?? ev.ThumbnailUrl,
        banner_url: ev.banner_url ?? ev.BannerUrl,
        description: ev.description ?? ev.Description,
        benefits: ev.benefits ?? ev.Benefits,
        requirements: ev.requirements ?? ev.Requirements,
        start_time: ev.start_time ?? ev.StartTime,
        end_time: ev.end_time ?? ev.EndTime,
        lat: ev.lat ?? ev.Lat,
        lng: ev.lng ?? ev.Lng,
      };
    }

    async function load() {
      const empty = $$('#empty');
      if (!slug) { empty.innerHTML = '<p class="muted">Thiáº¿u tham sá»‘ <code>slug</code>.</p>'; return; }

      try {
        const res = await fetch(`${API}/events/${encodeURIComponent(slug)}`);
        if (!res.ok) { empty.innerHTML = '<p class="muted">KhÃ´ng tÃ¬m tháº¥y sá»± kiá»‡n.</p>'; return; }
        const ev = normalize(await res.json());
        CURRENT_EVENT = ev;

        // header
        $$('#ev-title').textContent = ev.title || '';

        const tags = [];
        if (ev.category) tags.push(`<span class="tag">${ev.category}</span>`);
        if (ev.city) tags.push(`<span class="tag">${ev.city}</span>`);
        $$('#ev-tags').innerHTML = tags.join('');

        $$('#ev-cover').src = ev.banner_url || ev.thumbnail_url || '/assets/placeholder.jpg';
        $$('#ev-cover').alt = ev.title || 'Event cover';

        const d = fmtDate(ev.start_time);
        const t1 = fmtTimeHM(ev.start_time);
        const t2 = fmtTimeHM(ev.end_time);
        $$('#ev-date').textContent = d || '';
        $$('#ev-time').textContent = (t1 && t2) ? `${t1} â€“ ${t2}` : (t1 || '');

        $$('#ev-venue').textContent = ev.venue_name || ev.venue_address || ev.city || '';
        $$('#ev-capacity').textContent = ev.capacity ? `Sá»©c chá»©a: ${ev.capacity}` : 'â€”';
        $$('#ev-price').textContent = money(ev.price_cents, ev.currency);
        $$('#ev-desc').textContent = ev.description || 'â€”';

        const toList = txt => (txt || '').split(/\r?\n/)
          .map(s => s.trim()).filter(Boolean)
          .map(s => `<div class="li">âœ… <div>${s}</div></div>`).join('') || '<div class="muted">â€”</div>';

        $$('#ev-benefits').innerHTML = toList(ev.benefits);
        $$('#ev-reqs').innerHTML = toList(ev.requirements);

        // map
        if (typeof L !== 'undefined' && ev.lat != null && ev.lng != null) {
          const mapEl = $$('#map'); mapEl.style.display = 'block';
          const map = L.map('map').setView([ev.lat, ev.lng], 15);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OpenStreetMap' }).addTo(map);
          L.marker([ev.lat, ev.lng]).addTo(map);
          setTimeout(() => map.invalidateSize(true), 60);
        }


        $$('#event-card').hidden = false;
        empty.remove();
      } catch (e) {
        $$('#empty').innerHTML = '<p class="muted">CÃ³ lá»—i khi táº£i sá»± kiá»‡n.</p>';
        console.warn(e);
      }
    }

    // ----- BOOKING MODAL -----
    const modal = $$('#book-modal');
    const cashForm = $$('#cash-form');
    const msg = $$('#cash-msg');

    function openModal() { modal.classList.remove('hidden'); modal.setAttribute('aria-hidden', 'false'); }
    function closeModal() { modal.classList.add('hidden'); modal.setAttribute('aria-hidden', 'true'); cashForm.classList.add('hidden'); msg.textContent = ''; }

    document.addEventListener('click', (e) => { if (e.target && e.target.id === 'btnBook') openModal(); });
    modal?.addEventListener('click', (e) => { if (e.target.matches('[data-close]')) closeModal(); });

    $$('#btnCash')?.addEventListener('click', () => cashForm.classList.remove('hidden'));
    $$('#btnOnline')?.addEventListener('click', () => alert('Online Banking: Coming soon âœ¨'));

    // POST /api/bookings (giá»¯ chá»— + gá»­i mail)
    cashForm?.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!CURRENT_EVENT) return;

      const fd = new FormData(cashForm);
      const qtyInput = cashForm.querySelector('input[name="qty"]');
      const payload = {
        slug,
        method: 'cash',
        name: fd.get('fullName'),
        email: fd.get('email'),
        phone: fd.get('phone'),
        quantity: Number(fd.get('qty') || 1)
      };

      try {
        msg.textContent = 'Äang giá»¯ chá»— & gá»­i vÃ©...';
        const res = await fetch('/api/bookings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await res.json();

        if (res.status === 409 && data?.error === 'sold_out') {
          const remain = Number(data.remaining || 0);
          msg.textContent = `âš  Háº¿t chá»— cho sá»‘ lÆ°á»£ng yÃªu cáº§u. CÃ²n láº¡i: ${remain} vÃ©.`;
          if (qtyInput) {
            qtyInput.max = Math.max(remain, 0);
            if (remain === 0) qtyInput.value = 0;
            else if (Number(qtyInput.value) > remain) qtyInput.value = remain;
          }
          return;
        }

        if (!res.ok) throw new Error(data.detail || data.error || 'booking_failed');

        window.location.href = data.redirect || `/pages/booking-success.html?code=${encodeURIComponent(data.code)}`;
      } catch (err) {
        msg.textContent = 'âš  ' + err.message;
      }
    });

    load();
  </script>




</body>

</html>