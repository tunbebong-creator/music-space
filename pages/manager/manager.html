<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Manager Dashboard â€“ Music Space</title>
  <link rel="stylesheet" href="/assets/style.css" />
  <link rel="stylesheet" href="/assets/manager-dashboard.css" />
</head>
<body>
  <div class="container">
    <div class="topbar">
      <div class="h1">Báº£ng Ä‘iá»u khiá»ƒn (Manager)</div>
      <a class="back" href="/pages/healing-space.html">â† Quay láº¡i</a>
    </div>

    <div class="grid">
      <!-- Sá»± kiá»‡n -->
      <section class="card">
        <h3>Sá»± kiá»‡n Ä‘ang quáº£n lÃ½</h3>
        <div class="kpi-wrap">
          <div class="muted">Tá»•ng:</div>
          <div class="kpi-dot" id="kpi-events">â€”</div>
          <div class="toolbar">
            <a class="btn" href="/pages/manager/events.html">ğŸ“‹ Xem táº¥t cáº£</a>
            <a class="btn primary" href="/pages/manager/event-new.html">â• Táº¡o sá»± kiá»‡n</a>
            <a class="btn" href="/pages/manager/bookings.html">ğŸŸ Quáº£n lÃ½ vÃ©</a>
          </div>
        </div>

        <!-- danh sÃ¡ch sá»± kiá»‡n gáº§n Ä‘Ã¢y -->
        <div id="events-recent" class="list">
          <div class="muted">Äang táº£i...</div>
        </div>
      </section>

      <!-- KhÃ´ng gian -->
      <section class="card">
        <h3>KhÃ´ng gian</h3>
        <div class="stats">
          <div class="circle"><span id="spaceCount">0</span></div>
          <button onclick="window.location.href='/pages/manager/spaces.html'" class="btn btn-space">
            ğŸ“ Quáº£n lÃ½ khÃ´ng gian Ä‘Ã£ xÃ¡c nháº­n há»£p tÃ¡c
          </button>
        </div>
        <p class="muted">
          Quáº£n lÃ½ danh sÃ¡ch khÃ´ng gian Ä‘Ã£ Ä‘Æ°á»£c duyá»‡t/Ä‘á»“ng Ã½ há»£p tÃ¡c (dÃ¹ng Ä‘á»ƒ tá»• chá»©c sá»± kiá»‡n).
        </p>
      </section>
    </div>

    <section class="card" style="margin-top:18px">
      <h3>NgÆ°á»i dÃ¹ng</h3>
      <div class="kpi-wrap">
        <div class="muted">Tá»•ng:</div>
        <div class="kpi-dot" id="kpi-users">â€”</div>
        <div class="toolbar">
          <a class="btn" href="/pages/manager/users.html">ğŸ‘¥ Quáº£n lÃ½ ngÆ°á»i dÃ¹ng</a>
        </div>
      </div>
    </section>
  </div>

  <script>
    const API = '/api/manager';

    // Guard
    const u = JSON.parse(localStorage.getItem('ms_user') || 'null');
    if (!u || !['manager','admin'].includes((u.role||'').toLowerCase())) {
      window.location.href = '/index.html#login';
    }
    const H = { 'x-user-id': u.id, 'x-user-role': u.role };

    (async () => {
      try {
        // Láº¥y KPI cÆ¡ báº£n vÃ  toÃ n bá»™ events (dÃ¹ng Ä‘á»ƒ Ä‘áº¿m + recent)
        const [kpiRes, eventsRes] = await Promise.all([
          fetch(`${API}/kpi`, { headers: H }),
          fetch(`${API}/events`, { headers: H })
        ]);
        const kpi = await kpiRes.json();
        const list = await eventsRes.json();

        // KPI
        document.getElementById('kpi-events').textContent = list?.length ?? 0;
        document.getElementById('spaceCount').textContent = kpi?.spaces ?? 0;
        document.getElementById('kpi-users').textContent  = kpi?.users ?? 0;

        // Recent 3
        const recent = (list||[])
          .sort((a,b) => new Date(b.StartTime||b.EndTime||0) - new Date(a.StartTime||a.EndTime||0))
          .slice(0,3);

        const wrap = document.getElementById('events-recent');
        if (!recent.length) {
          wrap.innerHTML = '<div class="muted">ChÆ°a cÃ³ sá»± kiá»‡n.</div>';
          return;
        }
        wrap.innerHTML = recent.map(ev => {
          const d = ev.StartTime ? new Date(ev.StartTime).toLocaleDateString('vi-VN') : '';
          const t = ev.StartTime ? new Date(ev.StartTime).toLocaleTimeString('vi-VN',{hour:'2-digit',minute:'2-digit'}) : '';
          return `
            <article class="mini-card">
              ${ev.ThumbnailUrl ? `<img src="${ev.ThumbnailUrl}" class="thumb" alt="">` : ''}
              <div class="info">
                <div class="title">${ev.Title || ''}</div>
                <div class="muted">${ev.City ? `ğŸ“ ${ev.City} Â· ` : ''}${d} ${t}</div>
              </div>
              ${ev.Slug ? `<a class="btn small" href="/pages/event.html?slug=${ev.Slug}">Xem</a>` : ''}
            </article>
          `;
        }).join('');
      } catch (e) {
        console.warn(e);
        document.getElementById('events-recent').innerHTML = '<div class="muted">KhÃ´ng táº£i Ä‘Æ°á»£c dá»¯ liá»‡u.</div>';
      }
    })();
  </script>
</body>
</html>
