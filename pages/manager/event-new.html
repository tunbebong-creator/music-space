<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tạo sự kiện – Music Space</title>
  <link rel="stylesheet" href="/assets/style.css" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{--line:#e2e8f0;--muted:#64748b;--accent:#0ea5e9}
    body{background:#f1f5f9}
    .wrap{max-width:980px;margin:24px auto;background:#fff;border:1px solid var(--line);border-radius:16px;padding:18px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    label{font-weight:700}
    input,textarea,select{padding:10px;border:1px solid var(--line);border-radius:10px;width:100%}
    button{padding:10px 14px;border:0;border-radius:12px;background:var(--accent);color:#fff;font-weight:700;cursor:pointer}
    .muted{color:var(--muted)}
    .row-span-2{grid-column:1/3}
    .preview-img{width:100%;max-width:260px;height:140px;object-fit:cover;border-radius:8px;margin-top:6px;display:none}
    .inline{display:flex;gap:8px;align-items:center}
    .ok{outline:2px solid #22c55e}
    .err{outline:2px solid #ef4444}
    #mini-map{height:220px;border-radius:12px;border:1px solid var(--line);display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <a href="/pages/manager/manager.html" class="muted" style="text-decoration:none">← Quay lại Manager</a>
    <h2 style="margin:8px 0 16px">Tạo sự kiện mới</h2>

    <form id="ev-form" enctype="multipart/form-data">
      <div class="grid">
        <div>
          <label>Tiêu đề <span class="muted">*</span></label>
          <input name="title" required />
        </div>
        <div>
          <label>Loại</label>
          <select name="category">
            <option value="">— chọn —</option>
            <option>Sound Healing</option>
            <option>Meditation</option>
            <option>Acoustic Session</option>
            <option>Workshop</option>
            <option>Khác</option>
          </select>
        </div>

        <div>
          <label>Thành phố</label>
          <input name="city" placeholder="TP.HCM / Hà Nội / ..."/>
        </div>
        <div>
          <label>Địa điểm</label>
          <input name="venueName" placeholder="Tên không gian / phòng"/>
        </div>

        <div class="row-span-2">
          <label>Địa chỉ</label>
          <input name="venueAddress" placeholder="Số nhà, đường, quận/huyện..."/>
        </div>

        <!-- Google Maps URL + ẩn Lat/Lng -->
        <div class="row-span-2">
          <label>Google Maps URL</label>
          <input name="gmapsUrl" placeholder="Dán link Google Maps vào đây (vd: https://maps.google.com/...@16.0471,108.2062,17z)"/>
          <small class="muted">Hệ thống sẽ tự tách ra vĩ độ/kinh độ.</small>
          <input type="hidden" name="Lat" />
          <input type="hidden" name="Lng" />
        </div>

        <div>
          <label>Bắt đầu <span class="muted">*</span></label>
          <input type="datetime-local" name="startTime" required />
        </div>
        <div>
          <label>Kết thúc</label>
          <input type="datetime-local" name="endTime" />
        </div>

        <div>
          <label>Sức chứa</label>
          <input type="number" name="capacity" min="1" />
        </div>
        <div>
          <label>Giá (VND)</label>
          <input type="number" name="priceVND" placeholder="VD: 180000" />
        </div>
        <div>
          <label>Tiền tệ</label>
          <input name="currency" value="VND" />
        </div>
        <!-- Ẩn: priceCents cho backend -->
        <input type="hidden" name="priceCents" />

        <div class="row-span-2">
          <label>Mô tả</label>
          <textarea name="description" rows="3" placeholder="Giới thiệu sự kiện..."></textarea>
        </div>
        <div class="row-span-2">
          <label>Lợi ích</label>
          <textarea name="benefits" rows="2" placeholder="Mỗi dòng một lợi ích"></textarea>
        </div>
        <div class="row-span-2">
          <label>Yêu cầu</label>
          <textarea name="requirements" rows="2" placeholder="Mỗi dòng một yêu cầu"></textarea>
        </div>

        <div>
          <label>Thumbnail</label>
          <input type="file" name="thumbnail" accept="image/*" />
          <img id="thumb-preview" class="preview-img" alt="Thumbnail preview" />
        </div>
        <div>
          <label>Banner</label>
          <input type="file" name="banner" accept="image/*" />
          <img id="banner-preview" class="preview-img" alt="Banner preview" />
        </div>

        <div class="row-span-2">
          <label>Vị trí (preview)</label>
          <div id="mini-map"></div>
        </div>
      </div>

      <div class="inline" style="margin-top:12px">
        <button type="submit">Tạo sự kiện</button>
        <span id="ev-msg" class="muted"></span>
      </div>
    </form>
  </div>

  <script>
    const API = '/api/manager';
    const u = JSON.parse(localStorage.getItem('ms_user') || 'null');
    if (!u || !['manager','admin'].includes((u.role||'').toLowerCase())) {
      window.location.href = '/index.html#login';
    }
    const H = { 'x-user-id': u.id, 'x-user-role': u.role };

    // preview ảnh
    function bindPreview(input, img) {
      input?.addEventListener('change', () => {
        const f = input.files?.[0];
        if (!f) return (img.style.display = 'none');
        img.src = URL.createObjectURL(f);
        img.style.display = 'block';
      });
    }
    bindPreview(document.querySelector('input[name=thumbnail]'), document.getElementById('thumb-preview'));
    bindPreview(document.querySelector('input[name=banner]'), document.getElementById('banner-preview'));

    // parse GM url
    let miniMap, miniMarker;
    function ensureMiniMap(lat, lng) {
      const el = document.getElementById('mini-map');
      if (!el) return;
      el.style.display = 'block';
      if (!miniMap) {
        miniMap = L.map('mini-map').setView([lat, lng], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap' }).addTo(miniMap);
        miniMarker = L.marker([lat, lng]).addTo(miniMap);
      } else {
        miniMap.setView([lat, lng], 15);
        miniMarker.setLatLng([lat, lng]);
      }
      setTimeout(()=>miniMap.invalidateSize(true), 60);
    }
    function parseGMaps(v) {
      const regs = [
        /@(-?\d+\.\d+),\s*(-?\d+\.\d+)/,
        /place\/(-?\d+\.\d+),\s*(-?\d+\.\d+)/,
        /q=(-?\d+\.\d+),\s*(-?\d+\.\d+)/
      ];
      for (const re of regs) {
        const m = v.match(re);
        if (m) return { lat: +m[1], lng: +m[2] };
      }
      return null;
    }
    const gmapsInput = document.querySelector('input[name="gmapsUrl"]');
    gmapsInput?.addEventListener('change', e => {
      const latI = document.querySelector('input[name="Lat"]');
      const lngI = document.querySelector('input[name="Lng"]');
      const pos = parseGMaps(e.target.value.trim());
      if (pos) {
        latI.value = pos.lat;
        lngI.value = pos.lng;
        gmapsInput.classList.remove('err'); gmapsInput.classList.add('ok');
        ensureMiniMap(pos.lat, pos.lng);
      } else {
        latI.value = ''; lngI.value = '';
        gmapsInput.classList.remove('ok'); gmapsInput.classList.add('err');
        document.getElementById('mini-map').style.display = 'none';
      }
    });

    // Price VND -> priceCents
    const priceVND = document.querySelector('input[name="priceVND"]');
    const priceCents = document.querySelector('input[name="priceCents"]');
    function syncPrice() {
      const v = Number(priceVND.value || 0);
      priceCents.value = Number.isFinite(v) ? Math.round(v * 100) : 0;
    }
    priceVND?.addEventListener('input', syncPrice);

    // submit
    document.getElementById('ev-form')?.addEventListener('submit', async e => {
      e.preventDefault();
      const msg = document.getElementById('ev-msg'); msg.textContent = 'Đang tạo...';
      syncPrice();

      const title = e.target.title.value.trim();
      if (!title) { msg.textContent='⚠ Thiếu tiêu đề.'; return; }
      if (!e.target.startTime.value) { msg.textContent='⚠ Thiếu thời gian bắt đầu.'; return; }

      try {
        const fd = new FormData(e.target);
        const res = await fetch(`${API}/events`, { method: 'POST', headers: H, body: fd });
        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || data.error || 'Tạo sự kiện thất bại');

        msg.textContent = '✅ Tạo thành công';
        e.target.reset();
        document.getElementById('thumb-preview').style.display='none';
        document.getElementById('banner-preview').style.display='none';
        const el = document.getElementById('mini-map'); el.style.display='none';
        gmapsInput.classList.remove('ok','err');
      } catch (err) {
        msg.textContent = '⚠ ' + err.message;
      }
    });
  </script>
</body>
</html>
