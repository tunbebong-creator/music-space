<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Đặt lại mật khẩu • Music Space</title>
  <link rel="stylesheet" href="/assets/style.css" />
  <style>
    body{background:#f6f9fb;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    .wrap{max-width:520px;margin:48px auto;padding:0 16px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 18px 50px rgba(15,23,42,.06);overflow:hidden}
    .inner{padding:22px}
    h1{margin:0 0 4px;font-size:22px}
    p.muted{color:#64748b;margin-top:4px}
    label{font-weight:600;font-size:14px}
    .row{display:grid;gap:10px;margin:14px 0}
    input{width:100%;padding:11px 12px;border:1px solid #e2e8f0;border-radius:10px;font-size:14px}
    .actions{display:flex;gap:10px;align-items:center}
    button{padding:12px 16px;border:0;border-radius:12px;background:#111827;color:#fff;font-weight:700;cursor:pointer}
    button[disabled]{opacity:.6;cursor:not-allowed}
    #msg{font-weight:600}
    .ok{color:#16a34a}.err{color:#dc2626}
  </style>
</head>
<body>
  <main class="wrap">
    <div class="card">
      <div class="inner">
        <h1>Đặt lại mật khẩu</h1>
        <p class="muted">Nhập mật khẩu mới cho tài khoản của bạn.</p>

        <div id="tokenMsg" class="muted" style="margin:10px 0"></div>

        <form id="resetForm" class="row" novalidate>
          <div class="row">
            <label>Mật khẩu mới</label>
            <input id="pwd1" type="password" placeholder="••••••••" required />
          </div>
          <div class="row">
            <label>Nhập lại mật khẩu</label>
            <input id="pwd2" type="password" placeholder="••••••••" required />
          </div>

          <div class="actions">
            <button id="btnSubmit" type="submit">Cập nhật mật khẩu</button>
            <span id="msg"></span>
          </div>
        </form>
      </div>
    </div>
  </main>

  <!-- util chọn API base: /js/api.js (đã có trong dự án) -->
  <script src="/js/api.js"></script>
  <script>
    const qs   = new URLSearchParams(location.search);
    const token = (qs.get('token') || '').trim();

    const $ = s => document.querySelector(s);
    const tokenMsg = $('#tokenMsg');
    const form = $('#resetForm');
    const btn  = $('#btnSubmit');
    const msg  = $('#msg');

    // 1) Kiểm tra token còn hiệu lực
    async function verify() {
      if (!token) {
        tokenMsg.textContent = 'Thiếu mã token.';
        tokenMsg.className = 'err';
        form.style.display = 'none';
        return;
      }
      try {
        const r = await apiGetJSON('/auth/reset/' + encodeURIComponent(token));
        tokenMsg.textContent = 'Mã hợp lệ. Bạn có thể đặt lại mật khẩu.';
        tokenMsg.className = 'ok';
      } catch (e) {
        tokenMsg.textContent = 'Token không hợp lệ hoặc đã hết hạn.';
        tokenMsg.className = 'err';
        form.style.display = 'none';
      }
    }

    // 2) Gửi mật khẩu mới
    form?.addEventListener('submit', async (e) => {
      e.preventDefault();
      msg.textContent = '';
      msg.className = '';

      const p1 = $('#pwd1').value;
      const p2 = $('#pwd2').value;
      if (!p1 || p1.length < 6) {
        msg.textContent = 'Mật khẩu tối thiểu 6 ký tự.'; msg.className = 'err'; return;
      }
      if (p1 !== p2) {
        msg.textContent = 'Hai mật khẩu không khớp.'; msg.className = 'err'; return;
      }

      btn.disabled = true;
      msg.textContent = 'Đang cập nhật...';

      try {
        const r = await apiPostJSON('/auth/reset', { token, password: p1 });
        msg.textContent = 'Cập nhật thành công! Bạn có thể đăng nhập lại.';
        msg.className = 'ok';
        setTimeout(() => { location.href = '/index.html#login'; }, 1200);
      } catch (err) {
        msg.textContent = 'Lỗi: ' + (err.message || 'Không thể cập nhật.');
        msg.className = 'err';
      } finally {
        btn.disabled = false;
      }
    });

    verify();
  </script>
</body>
</html>
