<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ƒê·∫∑t v√© ‚Äì Music Space</title>
  <link rel="stylesheet" href="/assets/style.css"/>
  <style>
    :root{--line:#e2e8f0;--muted:#64748b;--accent:#0ea5e9}
    body{background:#f8fafc}
    .page{max-width:900px;margin:24px auto;padding:0 16px}
    .box{background:#fff;border:1px solid var(--line);border-radius:16px;padding:18px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:880px){.grid{grid-template-columns:1fr}}
    label{font-weight:700}
    input,textarea,select{padding:10px;border:1px solid var(--line);border-radius:10px;width:100%}
    .muted{color:var(--muted)}
    .btn{padding:10px 14px;border-radius:12px;border:1px solid var(--line);background:#fff;text-decoration:none;cursor:pointer}
    .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
    .ticket{margin-top:16px;display:grid;gap:12px;border:1px dashed #cbd5e1;border-radius:16px;padding:16px}
    .row{display:grid;gap:6px}
    .ok{color:#16a34a;font-weight:800}
  </style>
</head>
<body>
  <!-- header t√°i d√πng t·ª´ style.css -->
  <nav class="navbar">
    <div class="nav-inner">
      <a class="brand" href="/index.html"><span class="logo">‚ù§</span><span><strong>Music</strong> <span class="space">Space</span></span></a>
      <div class="nav-links">
        <a class="chip" href="/pages/healing-space.html">üó∫ Healing Space</a>
      </div>
    </div>
  </nav>

  <main class="page">
    <a class="btn" href="javascript:history.back()">‚Üê Quay l·∫°i</a>

    <section class="box">
      <h2 style="margin:6px 0 12px">ƒê·∫∑t v√© ti·ªÅn m·∫∑t</h2>
      <p class="muted" id="ev-brief">ƒêang t·∫£i th√¥ng tin s·ª± ki·ªán...</p>

      <form id="book-form" class="grid">
        <div>
          <label>H·ªç t√™n *</label>
          <input name="name" required/>
        </div>
        <div>
          <label>Email</label>
          <input type="email" name="email"/>
        </div>
        <div>
          <label>S·ªë ƒëi·ªán tho·∫°i</label>
          <input name="phone"/>
        </div>
        <div>
          <label>S·ªë l∆∞·ª£ng</label>
          <input type="number" name="quantity" min="1" value="1"/>
        </div>
        <div class="row" style="grid-column:1/-1">
          <label>Ghi ch√∫</label>
          <textarea name="note" rows="3" placeholder="Th√¥ng tin th√™m (n·∫øu c√≥)"></textarea>
        </div>

        <div style="grid-column:1/-1;display:flex;gap:10px;align-items:center">
          <button class="btn primary" type="submit">X√°c nh·∫≠n ƒë·∫∑t v√©</button>
          <span id="msg" class="muted"></span>
        </div>
      </form>

      <!-- V√© hi·ªÉn th·ªã sau khi ƒë·∫∑t th√†nh c√¥ng -->
      <div id="ticket" class="ticket" style="display:none">
        <div class="ok">‚úî ƒê·∫∑t v√© th√†nh c√¥ng!</div>
        <div><strong>V√©:</strong> <span id="t-code"></span></div>
        <div><strong>S·ª± ki·ªán:</strong> <span id="t-title"></span></div>
        <div><strong>Th·ªùi gian:</strong> <span id="t-time"></span></div>
        <div><strong>ƒê·ªãa ƒëi·ªÉm:</strong> <span id="t-venue"></span></div>
        <div><strong>S·ªë l∆∞·ª£ng:</strong> <span id="t-qty"></span></div>
        <div><strong>S·ªë ti·ªÅn:</strong> <span id="t-amount"></span></div>
        <div style="display:flex;gap:8px;margin-top:6px">
          <a class="btn" href="javascript:window.print()">In/Save v√©</a>
          <a class="btn" href="/pages/manager/manager.html">V·ªÅ trang qu·∫£n l√Ω</a>
        </div>
      </div>
    </section>
  </main>

  <footer class="footer">
    <div class="footer-inner">
      <div class="brand-footer">
        <span class="logo">‚ù§</span>
        <div>
          <div class="brand-text"><strong>Music</strong> <span class="space">Space</span></div>
          <p class="tagline">Vietnam's Healing Music Map</p>
        </div>
      </div>
    </div>
    <div class="copyright">¬© 2025 Music Space. All rights reserved.</div>
  </footer>

<script>
const params = new URL(location.href).searchParams;
const slug   = params.get('slug');
const method = params.get('method') || 'cash';
const H = {}; // (kh√¥ng b·∫Øt bu·ªôc login ƒë·ªÉ ƒë·∫∑t ti·ªÅn m·∫∑t)

if(!slug){ alert('Thi·∫øu slug s·ª± ki·ªán'); location.href='/'; }

// load t√≥m t·∫Øt s·ª± ki·ªán
(async ()=>{
  try{
    const r = await fetch(`/api/events/${encodeURIComponent(slug)}`);
    if(!r.ok) throw new Error('not_found');
    const ev = await r.json();
    window.__ev = ev;
    const dt = (t)=> t ? new Date(t).toLocaleString('vi-VN') : '';
    document.getElementById('ev-brief').innerHTML =
      `<strong>${ev.Title}</strong> ‚Äì ${dt(ev.StartTime)}<br/>`+
      `${ev.VenueName||ev.VenueAddress||ev.City||''}`;
  }catch(e){
    document.getElementById('ev-brief').textContent = 'Kh√¥ng t·∫£i ƒë∆∞·ª£c th√¥ng tin s·ª± ki·ªán.';
  }
})();

// submit ƒë·∫∑t v√©
document.getElementById('book-form').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const msg = document.getElementById('msg');
  msg.textContent = 'ƒêang x·ª≠ l√Ω...';

  try{
    const fd = new FormData(e.target);
    const payload = {
      method, slug,
      name: fd.get('name'),
      email: fd.get('email'),
      phone: fd.get('phone'),
      quantity: Number(fd.get('quantity')||1),
      note: fd.get('note')||''
    };

    const res = await fetch('/api/bookings', {
      method:'POST',
      headers:{'Content-Type':'application/json', ...H},
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    if(!res.ok) throw new Error(data.error || data.detail || 'ƒê·∫∑t v√© th·∫•t b·∫°i');

    msg.textContent = '';
    renderTicket(data);
    e.target.reset();
  }catch(err){
    msg.textContent = '‚ö† '+ err.message;
  }
});

function money(cents, cur='VND'){
  const v = Math.round(Number(cents||0)/100);
  return v.toLocaleString('vi-VN') + ' ' + cur;
}

function renderTicket(t){
  const ev = window.__ev || {};
  const dt = (x)=> x? new Date(x).toLocaleString('vi-VN') : '';
  document.getElementById('ticket').style.display='grid';
  document.getElementById('t-code').textContent   = t.code;
  document.getElementById('t-title').textContent  = ev.Title||'';
  document.getElementById('t-time').textContent   = dt(ev.StartTime);
  document.getElementById('t-venue').textContent  = ev.VenueName || ev.VenueAddress || ev.City || '';
  document.getElementById('t-qty').textContent    = t.quantity;
  document.getElementById('t-amount').textContent = money(t.amountCents, ev.Currency||'VND');
}
</script>
</body>
</html>
